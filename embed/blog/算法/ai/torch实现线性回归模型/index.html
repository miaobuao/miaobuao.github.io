<!DOCTYPE html><script type="module" src="/_astro/BlogPostEmbedLayout.astro_astro_type_script_index_0_lang.CBnQuka3.js"></script> <html lang="zh-CN" class="no-scrollbar"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>torch实现线性回归模型</title><!-- Open Graph / Facebook --><meta property="og:title" content="torch实现线性回归模型"><meta property="og:type" content="website"><meta property="og:url" content="https://yangqiuyi.com/embed/blog/%E7%AE%97%E6%B3%95/ai/torch%E5%AE%9E%E7%8E%B0%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B/"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.DY52MY3N.js"></script><link rel="stylesheet" href="/_astro/_slug_.DyZWVpeX.css"><script type="module" src="/_astro/page.nXIIYMne.js"></script></head> <body class="dark:text-white max-w-prose mx-auto">  <div class="flex flex-col rounded-lg"> <header class="p-4 flex flex-col"> <p class="break-all text-lg md:text-xl font-bold"> torch实现线性回归模型 </p> <p class="text-sm"> 杨秋逸 · 2022-03-04 </p> </header> <article class="prose max-sm:prose-sm dark:prose-invert text-inherit max-w-full py-4 px-4">  <p>视频：<a href="https://www.bilibili.com/video/BV1PX4y1g7KC?p=3">08 线性回归 + 基础优化算法【动手学深度学习v2】</a></p>
<h2 id="生成数据"><a href="#生成数据">生成数据</a></h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> torch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> synthetic_data</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">w, b, n_examples</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">: </span><span style="color:#6A737D"># 生成数据集</span></span>
<span class="line"><span style="color:#9ECBFF">    """生成 y = Xw + b + 噪声"""</span></span>
<span class="line"><span style="color:#6A737D">    # X是符合均值为0，方差为1的正态分布， size为(n_examples, len(w))的矩阵</span></span>
<span class="line"><span style="color:#E1E4E8">    X </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.normal</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">size</span><span style="color:#F97583">=</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">n_examples, </span><span style="color:#79B8FF">len</span><span style="color:#b392f0">(</span><span style="color:#E1E4E8">w</span><span style="color:#b392f0">)</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">    y </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.matmul</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">X, w</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> b</span></span>
<span class="line"><span style="color:#E1E4E8">    y </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> torch.normal</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0.01</span><span style="color:#E1E4E8">, y.shape</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> X, y.reshape</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">[</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#ffab70">]</span><span style="color:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">true_w </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.tensor</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">-</span><span style="color:#79B8FF">4.2</span><span style="color:#ffab70">]</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">true_b </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 3.6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">features,labels </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> synthetic_data</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">true_w, true_b, </span><span style="color:#79B8FF">1000</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#79b8ff">(</span><span style="color:#9ECBFF">"features: "</span><span style="color:#E1E4E8">, features.size</span><span style="color:#ffab70">(</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#79b8ff">(</span><span style="color:#9ECBFF">"labels: "</span><span style="color:#E1E4E8">, labels.size</span><span style="color:#ffab70">(</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="txt"><code><span class="line"><span>features:  torch.Size([1000, 2])</span></span>
<span class="line"><span>labels:  torch.Size([1000, 1])</span></span></code></pre>
<h2 id="生成批量数据batch"><a href="#生成批量数据batch">生成批量数据(batch)</a></h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> random</span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> data_iter</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">batch_size, features, labels</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">: </span><span style="color:#6A737D"># 生成batch(批量)数据的方法</span></span>
<span class="line"><span style="color:#E1E4E8">    num_examples </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> len</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">features</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">    indices </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> list</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">range</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">num_examples</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#6A737D"># 生成样本的下标</span></span>
<span class="line"><span style="color:#E1E4E8">    random.shuffle</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">indices</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#6A737D"># 打乱下标</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, num_examples, batch_size</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        batch_indices </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.tensor</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">indices</span><span style="color:#ffab70">[</span><span style="color:#E1E4E8">i: </span><span style="color:#79B8FF">min</span><span style="color:#b392f0">(</span><span style="color:#E1E4E8">i</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">batch_size, num_examples</span><span style="color:#b392f0">)</span><span style="color:#ffab70">]</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#F97583">        yield</span><span style="color:#E1E4E8"> features</span><span style="color:#79b8ff">[</span><span style="color:#E1E4E8">batch_indices</span><span style="color:#79b8ff">]</span><span style="color:#E1E4E8">, labels</span><span style="color:#79b8ff">[</span><span style="color:#E1E4E8">batch_indices</span><span style="color:#79b8ff">]</span></span></code></pre>
<h2 id="定义模型"><a href="#定义模型">定义模型</a></h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D"># 定义模型</span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> linreg</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">X, w, b</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> torch.matmul</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">X, w</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> b</span></span></code></pre>
<h2 id="随机梯度下降sgd"><a href="#随机梯度下降sgd">随机梯度下降（SGD）</a></h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> sgd</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">params, lr, batch_size</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#9ECBFF">    """小批量随机梯度下降方法"""</span></span>
<span class="line"><span style="color:#F97583">    with</span><span style="color:#E1E4E8"> torch.no_grad</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> param </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> params:</span></span>
<span class="line"><span style="color:#E1E4E8">            param </span><span style="color:#F97583">-=</span><span style="color:#E1E4E8"> lr </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> param.grad </span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> batch_size </span><span style="color:#6A737D"># 对参数进行优化</span></span>
<span class="line"><span style="color:#9ECBFF">            '''</span></span>
<span class="line"><span style="color:#9ECBFF">            因为是batch模式，一次输入了多个样本，所以param.grad是多个样本的累积梯度，</span></span>
<span class="line"><span style="color:#9ECBFF">            因此要除以batch_size，才能得到正确的梯度</span></span>
<span class="line"><span style="color:#9ECBFF">            参数的更新方法：</span></span>
<span class="line"><span style="color:#9ECBFF">                参数 := 参数 - 学习率*梯度</span></span>
<span class="line"><span style="color:#9ECBFF">            '''</span></span>
<span class="line"><span style="color:#E1E4E8">            param.grad.zero_</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#6A737D"># 梯度清零</span></span></code></pre>
<h2 id="均方损失函数"><a href="#均方损失函数">均方损失函数</a></h2>
<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>L</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>∗</mo><mo stretchy="false">(</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>−</mo><mi>y</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L = \frac{1}{2} * (\hat{y} - y) ^ 2</annotation></semantics></math></span>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> square_loss</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">y_hat, y</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#9ECBFF">    """均方损失函数"""</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">y_hat </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> y</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">**</span><span style="color:#79B8FF">2</span><span style="color:#F97583"> /</span><span style="color:#79B8FF"> 2</span></span></code></pre>
<h2 id="训练模型"><a href="#训练模型">训练模型</a></h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#79B8FF">EPOCHES</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 10</span><span style="color:#6A737D"> # 数据集循环轮数</span></span>
<span class="line"><span style="color:#E1E4E8">lr </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0.01</span><span style="color:#6A737D"> # learning rate 学习率</span></span>
<span class="line"><span style="color:#E1E4E8">net </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> linreg </span><span style="color:#6A737D"># 线性回归模型</span></span>
<span class="line"><span style="color:#E1E4E8">loss </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> square_loss</span></span>
<span class="line"><span style="color:#E1E4E8">batch_size </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"><span style="color:#6A737D"># 初始化参数</span></span>
<span class="line"><span style="color:#E1E4E8">w </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.normal</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0.01</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">size</span><span style="color:#F97583">=</span><span style="color:#ffab70">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#ffab70">)</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">requires_grad</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.zeros</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">requires_grad</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">EPOCHES</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> X, y </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data_iter</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">batch_size, features, labels</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        l </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> loss</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">net</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">X, w, b</span><span style="color:#ffab70">)</span><span style="color:#E1E4E8">, y</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#9ECBFF">        '''</span></span>
<span class="line"><span style="color:#9ECBFF">        计算出来的loss的shape是(batch_size, 1)，不是一个标量</span></span>
<span class="line"><span style="color:#9ECBFF">        因此我们需要对loss求sum，再求梯度</span></span>
<span class="line"><span style="color:#9ECBFF">        '''</span></span>
<span class="line"><span style="color:#E1E4E8">        l.sum</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">.backward</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">        sgd</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">[</span><span style="color:#E1E4E8">w, b</span><span style="color:#ffab70">]</span><span style="color:#E1E4E8">, lr, </span><span style="color:#79B8FF">len</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">X</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#F97583">    with</span><span style="color:#E1E4E8"> torch.no_grad</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        train_l </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> loss</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">net</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">features, w, b</span><span style="color:#ffab70">)</span><span style="color:#E1E4E8">, labels</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#79b8ff">(</span><span style="color:#9ECBFF">"epoch </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">, loss </span><span style="color:#79B8FF">%f</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> %</span><span style="color:#E1E4E8"> </span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">i</span><span style="color:#F97583">+</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">float</span><span style="color:#b392f0">(</span><span style="color:#E1E4E8">train_l.mean</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span><span style="color:#b392f0">)</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span></span></code></pre>
<p>运行结果：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="txt"><code><span class="line"><span>epoch 1, loss 2.347667</span></span>
<span class="line"><span>epoch 2, loss 0.326492</span></span>
<span class="line"><span>epoch 3, loss 0.045885</span></span>
<span class="line"><span>epoch 4, loss 0.006559</span></span>
<span class="line"><span>epoch 5, loss 0.000980</span></span>
<span class="line"><span>epoch 6, loss 0.000182</span></span>
<span class="line"><span>epoch 7, loss 0.000068</span></span>
<span class="line"><span>epoch 8, loss 0.000052</span></span>
<span class="line"><span>epoch 9, loss 0.000049</span></span>
<span class="line"><span>epoch 10, loss 0.000049</span></span></code></pre>
<h2 id="简洁实现"><a href="#简洁实现">简洁实现</a></h2>
<p>数据生成的方法是一样的，没有改动</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> torch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> synthetic_data</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">w, b, n_examples</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">: </span><span style="color:#6A737D"># 生成数据集</span></span>
<span class="line"><span style="color:#9ECBFF">    """生成 y = Xw + b + 噪声"""</span></span>
<span class="line"><span style="color:#6A737D">    # X是符合均值为0，方差为1的正态分布， size为(n_examples, len(w))的矩阵</span></span>
<span class="line"><span style="color:#E1E4E8">    X </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.normal</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">size</span><span style="color:#F97583">=</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">n_examples, </span><span style="color:#79B8FF">len</span><span style="color:#b392f0">(</span><span style="color:#E1E4E8">w</span><span style="color:#b392f0">)</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">    y </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.matmul</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">X, w</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> b</span></span>
<span class="line"><span style="color:#E1E4E8">    y </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> torch.normal</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0.01</span><span style="color:#E1E4E8">, y.shape</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> X, y.reshape</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">[</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#ffab70">]</span><span style="color:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">true_w </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> torch.tensor</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">-</span><span style="color:#79B8FF">4.2</span><span style="color:#ffab70">]</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">true_b </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 3.6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">features,labels </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> synthetic_data</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">true_w, true_b, </span><span style="color:#79B8FF">1000</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#79b8ff">(</span><span style="color:#9ECBFF">"features: "</span><span style="color:#E1E4E8">, features.size</span><span style="color:#ffab70">(</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#79b8ff">(</span><span style="color:#9ECBFF">"labels: "</span><span style="color:#E1E4E8">, labels.size</span><span style="color:#ffab70">(</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span></code></pre>
<p>batch的生成方式有所不同，这里使用torch的<code>DataLoader</code>进行处理</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> torch.utils.data </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> TensorDataset, DataLoader</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> load_array</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">data_arrays, batch_size, is_train</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    dataset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> TensorDataset</span><span style="color:#79b8ff">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">data_arrays</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> DataLoader</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">dataset, batch_size, </span><span style="color:#FFAB70">shuffle</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">is_train</span><span style="color:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">batch_size </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"><span style="color:#E1E4E8">data_iter </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> load_array</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">[</span><span style="color:#E1E4E8">features, labels</span><span style="color:#ffab70">]</span><span style="color:#E1E4E8">, batch_size</span><span style="color:#79b8ff">)</span></span></code></pre>
<p>torch里的<code>nn.Linear</code>就是我们需要用的线性回归模型，也叫<code>全连接层</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> torch </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> nn</span></span>
<span class="line"><span style="color:#E1E4E8">net </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nn.Sequential</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">nn.Linear</span><span style="color:#ffab70">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#6A737D"># 创建模型，用到了torch的Sequential类，可以理解成模型的容器，里面其实可以放多个模型，构成复杂神经网络</span></span>
<span class="line"><span style="color:#6A737D"># 初始化模型</span></span>
<span class="line"><span style="color:#E1E4E8">net</span><span style="color:#79b8ff">[</span><span style="color:#79B8FF">0</span><span style="color:#79b8ff">]</span><span style="color:#E1E4E8">.weight.data.normal_</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0.01</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#6A737D"># 设置w</span></span>
<span class="line"><span style="color:#E1E4E8">net</span><span style="color:#79b8ff">[</span><span style="color:#79B8FF">0</span><span style="color:#79b8ff">]</span><span style="color:#E1E4E8">.bias.data.fill_</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">0</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8"> </span><span style="color:#6A737D"># 设置b</span></span></code></pre>
<p>训练模型</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#79B8FF">EPOCHES</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 10</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> range</span><span style="color:#79b8ff">(</span><span style="color:#79B8FF">EPOCHES</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> X, y </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data_iter:</span></span>
<span class="line"><span style="color:#E1E4E8">        l </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> loss</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">net</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">X</span><span style="color:#ffab70">)</span><span style="color:#E1E4E8">, y</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">        trainer.zero_grad</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">        l.backward</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">        trainer.step</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#E1E4E8">    l </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> loss</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">net</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">features</span><span style="color:#ffab70">)</span><span style="color:#E1E4E8">, labels</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#79b8ff">(</span><span style="color:#9ECBFF">"epoch </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">, loss </span><span style="color:#79B8FF">%f</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> %</span><span style="color:#E1E4E8"> </span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">i</span><span style="color:#F97583">+</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, l</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span></span></code></pre>  </article> </div> <div class="mt-8 p-2"> <script type="module" src="/_astro/Giscus.astro_astro_type_script_index_0_lang.C2pfN53L.js"></script> <giscus-widget repo="miaobuao/miaobuao.github.io" repoId="R_kgDOJONNeg" categoryId="DIC_kwDOJONNes4CVJhu" mapping="og:title" strict="0" reactionsEnabled="1" emitMetadata="0" inputPosition="top" theme="preferred_color_scheme" lang="zh-CN" loading="lazy"></giscus-widget> </div><div class="h-16 sm:h-0"></div>  </body></html>