<!DOCTYPE html><script type="module" src="/_astro/BlogPostLayout.astro_astro_type_script_index_0_lang.CQKIrR8a.js"></script> <html lang="zh-CN" class="no-scrollbar"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Nuxt/Nitro 集成 Cloudflare D1 Database</title><!-- Open Graph / Facebook --><meta property="og:title" content="Nuxt/Nitro 集成 Cloudflare D1 Database"><meta property="og:type" content="website"><meta property="og:url" content="https://yangqiuyi.com/blog/kai-fa/nuxt_nitro-ji-cheng-cloudflare-d1-database/"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.DY52MY3N.js"></script><link rel="stylesheet" href="/_astro/_slug_.DyZWVpeX.css">
<style>progressive-image[data-astro-cid-njl3qch2]{display:block}
@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0;mix-blend-mode:plus-lighter}to{opacity:1;mix-blend-mode:plus-lighter}}@keyframes astroFadeOut{0%{opacity:1;mix-blend-mode:plus-lighter}to{opacity:0;mix-blend-mode:plus-lighter}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media(prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
</style><script type="module" src="/_astro/page.nXIIYMne.js"></script><style>[data-astro-transition-scope="astro-uniujczg-1"] { view-transition-name: avatar; }@layer astro { ::view-transition-old(avatar) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(avatar) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(avatar) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(avatar) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-uniujczg-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-uniujczg-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-uniujczg-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-uniujczg-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-uniujczg-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-uniujczg-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-uniujczg-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-uniujczg-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style></head> <body class="dark:text-white"> <div class="relative h-screen pointer-events-none"> <div class="absolute w-screen h-screen pointer-events-none" data-astro-transition-persist="bg"> <script type="module" src="/_astro/ProgressiveImage.astro_astro_type_script_index_0_lang.Zsl7yvEt.js"></script> <progressive-image data-url="/images/3e171a532cf6845d0fe58924cc998f9b1c7244546777b816d44fe196656b3c4b.webp" data-thumbnailUrl="/images/3e171a532cf6845d0fe58924cc998f9b1c7244546777b816d44fe196656b3c4b_48x.webp" data-image-class="object-cover object-center size-full pointer-events-none" data-astro-cid-njl3qch2="true" class="relative size-full pointer-events-none"> <img src="/images/3e171a532cf6845d0fe58924cc998f9b1c7244546777b816d44fe196656b3c4b_48x.webp" class="image-pixelated object-cover object-center size-full pointer-events-none" data-astro-cid-njl3qch2> </progressive-image>  </div> <div class="pointer-events-auto"><div class="absolute size-full max-w-7xl left-0 right-0 mx-auto sm:p-2"> <div class="sm:glassmorphism size-full rounded-md flex flex-row gap-2"> <div class="fixed w-full sm:w-50 lg:w-52 bottom-0 left-0 z-50 sm:static sm:flex sm:flex-col sm:overflow-auto no-scrollbar gap-2"> <div class="hidden sm:flex flex-col gap-1 justify-center items-center p-4" data-astro-transition-persist="author-info"> <img src="https://avatars.githubusercontent.com/u/62047803?v=4" alt="秋逸" class="rounded-full size-24 select-none" loading="lazy"> <p class="text-2xl font-bold">杨秋逸</p> <p class="text-sm">To Be A Geek :)</p> </div> <div class="flex flex-row sm:flex-col w-full justify-around border-none max-sm:glassmorphism sm:p-2"> <a class="transition-all flex flex-col items-center justify-center py-2 rounded-md max-sm:gap-0.5 sm:flex-row sm:justify-start sm:gap-4 sm:px-4 border-none  sm:glassmorphism" role="button" tabindex="0" href="/"> <div class="flex justify-center items-center"> <i class="icon-[material-symbols--nest-clock-farsight-analog] size-6 sm:size-8"></i> </div> <div class="text-xs sm:text-base select-none">  
Timeline
 </div> </a> <a class="transition-all flex flex-col items-center justify-center py-2 rounded-md max-sm:gap-0.5 sm:flex-row sm:justify-start sm:gap-4 sm:px-4 border-none" role="button" tabindex="0" href="/archive"> <div class="flex justify-center items-center"> <i class="icon-[icon-park-outline--calendar] size-6 sm:size-8"></i> </div> <div class="text-xs sm:text-base select-none">  
Archive
 </div> </a>   <a class="transition-all flex flex-col items-center justify-center py-2 rounded-md max-sm:gap-0.5 sm:flex-row sm:justify-start sm:gap-4 sm:px-4 border-none hidden sm:flex" role="button" tabindex="0" href="/friend-links/"> <div class="flex justify-center items-center"> <i class="icon-[icon-park-outline--friends-circle] size-6 sm:size-8"></i> </div> <div class="text-xs sm:text-base select-none">  
Friends
 </div> </a> <a class="transition-all flex flex-col items-center justify-center py-2 rounded-md max-sm:gap-0.5 sm:flex-row sm:justify-start sm:gap-4 sm:px-4 border-none max-sm:flex hidden" role="button" tabindex="0" href="/finder"> <div class="flex justify-center items-center"> <i class="icon-[ix--navigation] size-6 sm:size-8"></i> </div> <div class="text-xs sm:text-base select-none">  
Finder
 </div> </a> <a class="transition-all flex flex-col items-center justify-center py-2 rounded-md max-sm:gap-0.5 sm:flex-row sm:justify-start sm:gap-4 sm:px-4 border-none" role="button" tabindex="0" href="/about-me"> <div class="flex justify-center items-center"> <i class="icon-[material-symbols--sentiment-excited-outline] size-6 sm:size-8"></i> </div> <div class="text-xs sm:text-base select-none">  
About Me
 </div> </a> </div> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z2plROE" component-url="/_astro/WindowsList.De5TXCyW.js" component-export="WindowsList" renderer-url="/_astro/client.DkS6DsO7.js" props="{&quot;className&quot;:[0,&quot;flex-1 hidden sm:flex flex-col gap-1 overflow-auto px-2&quot;]}" ssr client="only" opts="{&quot;name&quot;:&quot;WindowsList&quot;,&quot;value&quot;:&quot;solid-js&quot;}"></astro-island> </div> <main id="main-scroll-container" class="overflow-auto h-full flex-1 no-scrollbar"> <div class="p-2 sm:pl-0">  <div class="flex flex-col glassmorphism rounded-lg"> <header class="p-4 gap-3 flex items-center sm:hidden"> <img src="https://avatars.githubusercontent.com/u/62047803?v=4" alt="秋逸" class="size-[3rem] rounded-full select-none" data-astro-transition-scope="astro-uniujczg-1"> <div class="flex flex-col"> <p class="break-all text-lg md:text-xl font-bold"> Nuxt/Nitro 集成 Cloudflare D1 Database </p> <p class="text-sm"> 杨秋逸 · 2025-01-03 </p> </div> </header> <article class="prose max-sm:prose-sm dark:prose-invert text-inherit max-w-full py-4 px-4 md:px-8">  <h1 id="nuxtnitro-集成-cloudflare-d1-database"><a href="#nuxtnitro-集成-cloudflare-d1-database">Nuxt/Nitro 集成 Cloudflare D1 Database</a></h1>
<h2 id="d1-database"><a href="#d1-database">D1 Database</a></h2>
<p>D1 是 Cloudflare 提供的分布式数据库，本身基于 SQLite 开发，因此很多 ORM 都可以对接（例如 <a href="https://www.prisma.io/docs/orm/overview/introduction/what-is-prisma"><code>Prisma ORM</code></a>, <a href="https://orm.drizzle.team/"><code>drizzle</code></a>）。不过截止至 2025.01.02，笔者并不推荐使用 Prisma 来搭配 D1 Database，诚然 Prisma 是一个优秀的 ORM 库，但是它的 Query Engine 是用的 WASM，体积比较大，Cloudflare Worker 免费计划的单个项目的最大体积必须在 3M 以内（gzip），付费计划最大体积是10M（gzip）<sup><a href="#user-content-fn-https://developers.cloudflare.com/workers/platform/limits/#worker-size" id="user-content-fnref-https://developers.cloudflare.com/workers/platform/limits/#worker-size" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup>，这空间十分滴珍贵，不能浪费在这种地方（但是Prisma未来的计划就是逐步缩小 Query Engine 的体积，所以未来说不定可以考虑 Prisma），因此本文使用 drizzle。</p>
<h2 id="wrangler"><a href="#wrangler">wrangler</a></h2>
<p><a href="https://www.npmjs.com/package/wrangler">wrangler</a> 是 Cloudflare 提供的的命令行工具，提供了一个简单的接口，可以让在本地开发环境中利用 <a href="https://github.com/cloudflare/miniflare">miniflare</a> 创建 Cloudflare Worker 的模拟环境。</p>
<p>首先你需要有一个 Cloudflare 账号，对此本文不做赘述。</p>
<h3 id="安装"><a href="#安装">安装</a></h3>
<p>我们可以在你的项目里使用你喜爱的包管理安装 wrangler。</p>
<p><strong>pnpm</strong>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpm</span><span style="color:#9ECBFF"> add</span><span style="color:#79B8FF"> -D</span><span style="color:#9ECBFF"> wrangler</span></span></code></pre>
<p><strong>bun</strong>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">bun</span><span style="color:#9ECBFF"> add</span><span style="color:#79B8FF"> -D</span><span style="color:#9ECBFF"> wrangler</span></span></code></pre>
<h3 id="登录"><a href="#登录">登录</a></h3>
<p>在使用 wrangler 创建环境前，需要先使用这条指令来登录 cloudflare：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpx</span><span style="color:#9ECBFF"> wrangler</span><span style="color:#9ECBFF"> login</span></span></code></pre>
<p>（为了方便起见，本文将用更加流行的 pnpm 来进行演示，如果你使用的是bun的话，只需要把下面的指令从 <code>pnpx</code> 换成 <code>bunx</code> 即可）</p>
<p>这条指令会自动用浏览器打开一个标签页，需要你登录cloudflare账号，然后授权登录本地的wrangler。</p>
<h3 id="创建-d1-database"><a href="#创建-d1-database">创建 D1 Database</a></h3>
<p>登陆完 wrangler 之后可以用命令行来创建 D1 数据库了，我们用这条指令可以创建一个名为 Test 的数据库：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpx</span><span style="color:#9ECBFF"> wrangler</span><span style="color:#9ECBFF"> d1</span><span style="color:#9ECBFF"> create</span><span style="color:#9ECBFF"> Test</span></span></code></pre>
<p>会看到如下输出：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0"> ⛅️</span><span style="color:#9ECBFF"> wrangler</span><span style="color:#79B8FF"> 3.99.0</span></span>
<span class="line"><span style="color:#B392F0">-------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">✅</span><span style="color:#9ECBFF"> Successfully</span><span style="color:#9ECBFF"> created</span><span style="color:#9ECBFF"> DB</span><span style="color:#9ECBFF"> 'Test'</span><span style="color:#9ECBFF"> in</span><span style="color:#9ECBFF"> region</span><span style="color:#9ECBFF"> WNAM</span></span>
<span class="line"><span style="color:#B392F0">Created</span><span style="color:#9ECBFF"> your</span><span style="color:#9ECBFF"> new</span><span style="color:#9ECBFF"> D1</span><span style="color:#9ECBFF"> database.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79b8ff">[</span><span style="color:#ffab70">[</span><span style="color:#E1E4E8">d1_databases</span><span style="color:#ffab70">]</span><span style="color:#79b8ff">]</span></span>
<span class="line"><span style="color:#B392F0">binding</span><span style="color:#9ECBFF"> =</span><span style="color:#9ECBFF"> "DB"</span></span>
<span class="line"><span style="color:#B392F0">database_name</span><span style="color:#9ECBFF"> =</span><span style="color:#9ECBFF"> "Test"</span></span>
<span class="line"><span style="color:#B392F0">database_id</span><span style="color:#9ECBFF"> =</span><span style="color:#9ECBFF"> "a33752ea-32ed-4f44-80a3-71cf2cf55522"</span></span></code></pre>
<p>把 <code>[[d1_databases]]</code> 及以后的文本给复制下来，在项目根目录创建一个名为 <code>wrangler.toml</code> 的文件，把刚才复制的内容粘贴进去, 然后在该文件的开头加上关于项目的一些配置, 例如：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="toml"><code><span class="line"><span style="color:#E1E4E8">name=</span><span style="color:#9ECBFF">"cf-nitro"</span></span>
<span class="line"><span style="color:#E1E4E8">pages_build_output_dir=</span><span style="color:#9ECBFF">"dist"</span></span></code></pre>
<p>其中 name 是项目名称，pages_build_output_dir 是编译结果的输出文件夹。最终效果如图：</p>
<p><img alt="vscode: wrangler.toml" loading="lazy" decoding="async" fetchpriority="auto" width="1648" height="624" src="/_astro/image-2.AXO1yndK_PlAUr.webp" ></p>
<p><code>wrangler.toml</code> 是 Cloudflare Worker 的配置文件，虽然现在已经有了 <a href="https://github.com/cloudflare/workers-sdk/issues/2376">JSON 格式</a>，但是 toml 格式更加稳定些。</p>
<p>此时我们登录网页端的 Cloudflare Dashboard，进入 <code>D1 SQL</code> 页面：</p>
<p><img alt="D1 SQL" loading="lazy" decoding="async" fetchpriority="auto" width="391" height="753" src="/_astro/image.BdzXqiR8_Z54zO5.webp" ></p>
<p>会看到多出来了一个数据库，名为 Test：</p>
<p><img alt="Test" loading="lazy" decoding="async" fetchpriority="auto" width="2010" height="600" src="/_astro/image-1.MLtfmy-2_Zy9HHm.webp" ></p>
<p>也可以在命令行里使用 <code>pnpx wrangler d1 list</code> 来查看已有的数据库：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#F97583">></span><span style="color:#E1E4E8"> pnpx wrangler d1 list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0"> ⛅️</span><span style="color:#9ECBFF"> wrangler</span><span style="color:#79B8FF"> 3.99.0</span></span>
<span class="line"><span style="color:#B392F0">-------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">┌──────────┬────────┬──────────────┬────────────┬────────────┬───────────┐</span></span>
<span class="line"><span style="color:#B392F0">│</span><span style="color:#9ECBFF"> uuid</span><span style="color:#9ECBFF">     │</span><span style="color:#9ECBFF"> name</span><span style="color:#9ECBFF">   │</span><span style="color:#9ECBFF"> created_at</span><span style="color:#9ECBFF">   │</span><span style="color:#9ECBFF"> version</span><span style="color:#9ECBFF">    │</span><span style="color:#9ECBFF"> num_tables</span><span style="color:#9ECBFF"> │</span><span style="color:#9ECBFF"> file_size</span><span style="color:#9ECBFF"> │</span></span>
<span class="line"><span style="color:#B392F0">├──────────┼────────┼──────────────┼────────────┼────────────┼───────────┤</span></span>
<span class="line"><span style="color:#B392F0">│</span><span style="color:#9ECBFF"> a3375...</span><span style="color:#9ECBFF"> │</span><span style="color:#9ECBFF"> Test</span><span style="color:#9ECBFF">   │</span><span style="color:#9ECBFF"> 2025-01-...</span><span style="color:#9ECBFF">  │</span><span style="color:#9ECBFF"> production</span><span style="color:#9ECBFF"> │</span><span style="color:#9ECBFF">            │</span><span style="color:#9ECBFF">           │</span></span>
<span class="line"><span style="color:#B392F0">├──────────┼────────┼──────────────┼────────────┼────────────┼───────────┤</span></span></code></pre>
<p>至此，我们的数据库已经创建好了，接下来我们要用 ORM 库来创建一个演示用的表。</p>
<h2 id="drizzle"><a href="#drizzle">drizzle</a></h2>
<p><a href="https://orm.drizzle.team/docs/get-started/d1-new">drizzle</a> 是一个基于 TypeScript 的 ORM 库，很早就支持 D1 了，因此也比较成熟易用。</p>
<p>首先安装依赖：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpm</span><span style="color:#9ECBFF"> add</span><span style="color:#79B8FF"> -D</span><span style="color:#9ECBFF"> drizzle-orm</span><span style="color:#9ECBFF"> drizzle-kit</span></span></code></pre>
<p>CLoudflare Worker 的运行时并不是 NodeJS，而是他们自研的 <a href="https://github.com/cloudflare/workerd">workerd</a>，为了兼容大部分的 NodeAPI，我们要往 <code>wrangler.toml</code> 里写入：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="toml"><code><span class="line"><span style="color:#E1E4E8">compatibility_flags = </span><span style="color:#79b8ff">[</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">"nodejs_compat"</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">]</span></span>
<span class="line"><span style="color:#E1E4E8">compatibility_date = </span><span style="color:#9ECBFF">"2025-01-02"</span></span></code></pre>
<ul>
<li><code>compatibility_flags</code> 设置为 <code>["nodejs_compat"]</code> 意味着在我们的项目中同时启用了 workerd 内建的 API 和 NodeJS 的 polyfills。</li>
<li><code>compatibility_date</code> 设置为 <code>"2025-01-02"</code>，表示我们确保我们的项目兼容截止到2025年1月2日的 Cloudflare Worker 运行时。</li>
</ul>
<h3 id="schema"><a href="#schema">Schema</a></h3>
<p>我们一直说 drizzle 是一个 ORM 库，这意味着他的所有操作（增删改查，创建数据库等）都是基于 Schema 来完成的。</p>
<p>我们在项目中创建一个 <code>db/schema/user.ts</code>, 定义一张User表，写入如下代码：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">{</span><span style="color:#E1E4E8"> int, sqliteTable, text </span><span style="color:#79b8ff">}</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "drizzle-orm/sqlite-core"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> const</span><span style="color:#79B8FF"> usersTable</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> sqliteTable</span><span style="color:#79b8ff">(</span><span style="color:#9ECBFF">"users_table"</span><span style="color:#E1E4E8">, </span><span style="color:#ffab70">{</span></span>
<span class="line"><span style="color:#E1E4E8">  id: </span><span style="color:#B392F0">int</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">primaryKey</span><span style="color:#b392f0">(</span><span style="color:#79b8ff">{</span><span style="color:#E1E4E8"> autoIncrement: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">}</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  name: </span><span style="color:#B392F0">text</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">notNull</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  age: </span><span style="color:#B392F0">int</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">notNull</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  email: </span><span style="color:#B392F0">text</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">notNull</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">unique</span><span style="color:#b392f0">(</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#ffab70">}</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>如图：</p>
<p><img alt="vscode: db/schema/user.ts" loading="lazy" decoding="async" fetchpriority="auto" width="1561" height="858" src="/_astro/image-3.CowY0kq4_Z1pSuUf.webp" ></p>
<h3 id="drizzleconfigts"><a href="#drizzleconfigts">drizzle.config.ts</a></h3>
<p>现在我们有了 schema，就可以使用 drizzle-kit 来生成 SQL 语句了，但是在此之前，我们还需要创建一个 <code>drizzle.config.ts</code>，来告诉 <code>drizzle-kit</code> schema 的位置，以及生成的 SQL 语句应该放置在哪里：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">{</span><span style="color:#E1E4E8"> defineConfig </span><span style="color:#79b8ff">}</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'drizzle-kit'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#B392F0"> defineConfig</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">{</span></span>
<span class="line"><span style="color:#E1E4E8">  out: </span><span style="color:#9ECBFF">'./drizzle'</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// SQL 的输出路径</span></span>
<span class="line"><span style="color:#E1E4E8">  schema: </span><span style="color:#9ECBFF">'./server/db/schema'</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// schema 的位置</span></span>
<span class="line"><span style="color:#E1E4E8">  dialect: </span><span style="color:#9ECBFF">'sqlite'</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 正如我们上文所说，D1 是基于 SQLite 的</span></span>
<span class="line"><span style="color:#ffab70">}</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>如图：</p>
<p><img alt="vscode: drizzle.config.ts" loading="lazy" decoding="async" fetchpriority="auto" width="1327" height="778" src="/_astro/image-5.DKV4wNCZ_ZACtmj.webp" ></p>
<h3 id="生成-sql"><a href="#生成-sql">生成 SQL</a></h3>
<p>现在我们有了 schema，也有了 drizzle.config.ts，可以用 drizzle-kit 生成 SQL 语句了，使用如下命令:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpx</span><span style="color:#9ECBFF"> drizzle-kit</span><span style="color:#9ECBFF"> generate</span></span></code></pre>
<p>可以看到如下输出：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#F97583">></span><span style="color:#E1E4E8"> pnpx drizzle-kit generate</span></span>
<span class="line"><span style="color:#B392F0">No</span><span style="color:#9ECBFF"> config</span><span style="color:#9ECBFF"> path</span><span style="color:#9ECBFF"> provided,</span><span style="color:#9ECBFF"> using</span><span style="color:#9ECBFF"> default</span><span style="color:#9ECBFF"> 'drizzle.config.ts'</span></span>
<span class="line"><span style="color:#B392F0">Reading</span><span style="color:#9ECBFF"> config</span><span style="color:#9ECBFF"> file</span><span style="color:#9ECBFF"> '...\drizzle.config.ts'</span></span>
<span class="line"><span style="color:#B392F0">1</span><span style="color:#9ECBFF"> tables</span></span>
<span class="line"><span style="color:#B392F0">users_table</span><span style="color:#79B8FF"> 4</span><span style="color:#9ECBFF"> columns</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> indexes</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF"> fks</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79b8ff">[</span><span style="color:#E1E4E8">✓</span><span style="color:#79b8ff">]</span><span style="color:#E1E4E8"> Your SQL migration file ➜ drizzle</span><span style="color:#79B8FF">\0</span><span style="color:#E1E4E8">000_worthless_ravenous.sql 🚀</span></span></code></pre>
<p>然后我们会发现自己的项目目录下多了一个名为 <code>drizzle</code> 的文件夹，里面有一个名为 <code>0000_worthless_ravenous.sql</code> 的文件，这就是我们的 drizzle 生成的 SQL 语句了。当然你的文件名可能不是 <code>0000_worthless_ravenous.sql</code>，这是 drizzle 使用随机的单词生成的，无所谓文件名，只要不重复就行了。</p>
<h2 id="迁移数据库"><a href="#迁移数据库">迁移数据库</a></h2>
<p>现在我们有了 SQL 语句，也登陆好了 wrangler，接下来我们就可以用 wrangler 把这些 SQL 语句应用到 D1 数据库上了。</p>
<p>不过为了让 wrangler 知道我们生成的 SQL 文件的路径，我们还需要往 <code>wrangler.toml</code> 里添加一行：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="toml"><code><span class="line"><span style="color:#E1E4E8">migrations_dir = </span><span style="color:#9ECBFF">"drizzle"</span></span></code></pre>
<p>如图:</p>
<p><img alt="vscode: wrangler.toml append migrations_dir" loading="lazy" decoding="async" fetchpriority="auto" width="1903" height="873" src="/_astro/image-4.Cmwy-1Jm_VBpoQ.webp" ></p>
<p>然后我们就可以愉快地用 wrangler 进行数据库迁移了(这条指令中的Test就是我们刚才创建的 Test 数据库，如果的你数据库使用了其他名字，需要自行替换)：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpx</span><span style="color:#9ECBFF"> wrangler</span><span style="color:#9ECBFF"> d1</span><span style="color:#9ECBFF"> migrations</span><span style="color:#9ECBFF"> apply</span><span style="color:#9ECBFF"> Test</span><span style="color:#79B8FF"> --local</span></span></code></pre>
<p>使用这条指令后会看到如下输出：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0"> ⛅️</span><span style="color:#9ECBFF"> wrangler</span><span style="color:#79B8FF"> 3.99.0</span></span>
<span class="line"><span style="color:#B392F0">-------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">Migrations</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> be</span><span style="color:#9ECBFF"> applied:</span></span>
<span class="line"><span style="color:#B392F0">┌─────────────────────────────┐</span></span>
<span class="line"><span style="color:#B392F0">│</span><span style="color:#9ECBFF"> name</span><span style="color:#9ECBFF">                        │</span></span>
<span class="line"><span style="color:#B392F0">├─────────────────────────────┤</span></span>
<span class="line"><span style="color:#B392F0">│</span><span style="color:#9ECBFF"> 0000_worthless_ravenous.sql</span><span style="color:#9ECBFF"> │</span></span>
<span class="line"><span style="color:#B392F0">└─────────────────────────────┘</span></span>
<span class="line"><span style="color:#F97583">?</span><span style="color:#E1E4E8"> About to apply 1 migration</span><span style="color:#79b8ff">(</span><span style="color:#B392F0">s</span><span style="color:#79b8ff">)</span></span>
<span class="line"><span style="color:#B392F0">Your</span><span style="color:#9ECBFF"> database</span><span style="color:#9ECBFF"> may</span><span style="color:#9ECBFF"> not</span><span style="color:#9ECBFF"> be</span><span style="color:#9ECBFF"> available</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> serve</span><span style="color:#9ECBFF"> requests</span><span style="color:#9ECBFF"> during</span><span style="color:#9ECBFF"> the</span><span style="color:#9ECBFF"> migration,</span><span style="color:#9ECBFF"> continue?</span><span style="color:#9ECBFF"> »</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">Y/n</span><span style="color:#79b8ff">)</span></span></code></pre>
<p>我们回车即可：</p>
<p><img alt="wrangler d1 migrations apply --local" loading="lazy" decoding="async" fetchpriority="auto" width="1482" height="616" src="/_astro/image-6.BjVMMPVR_Z10HKS8.webp" ></p>
<p>等这条指令执行完，不出意外的话，我们的项目里会多出一个 <code>.wrangler</code> 文件夹，这就是用于存放 miniflare 数据的路径。</p>
<p><img alt="vscode: .wrangler" loading="lazy" decoding="async" fetchpriority="auto" width="798" height="177" src="/_astro/image-7.CF_xcqeg_Z18MYCa.webp" ></p>
<p>至此，我们的 SQL 语句已经成功应用到我们<strong>本地</strong>的 D1 数据库上了，用 SQLite 工具预览数据库，可以看到如下结果:</p>
<p><img alt="SQLite result" loading="lazy" decoding="async" fetchpriority="auto" width="1969" height="432" src="/_astro/image-8.C7OHuxK-_Z1vyjQR.webp" ></p>
<h2 id="在-nuxtnitro-中使用-d1-database"><a href="#在-nuxtnitro-中使用-d1-database">在 Nuxt/Nitro 中使用 D1 Database</a></h2>
<p>在上文中，我们已经创建完了一个名为 Test 的 D1 数据库，接下来可以在我们的 Nuxt/Nitro 项目中使用了。</p>
<p>(由于 Nuxt 是基于 Nitro 和 Vue 的一个前端框架，因此本文介绍的方法同样可以在 Nuxt 框架中使用。)</p>
<p>然后我们安装 <a href="https://github.com/nitrojs/nitro-cloudflare-dev"><code>nitro-cloudflare-dev</code></a>，这是 nitro 的一个 module, 允许在 nitro 的 dev Server 中使用 wrangler 和 miniflare 暴露的 <a href="https://github.com/cloudflare/workers-sdk/pull/5002">getPlatformProxy API</a> 来访问 Cloudflare runtime platform:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpm</span><span style="color:#9ECBFF"> add</span><span style="color:#79B8FF"> -D</span><span style="color:#9ECBFF"> nitro-cloudflare-dev</span></span></code></pre>
<p><code>nitro-cloudflare-dev</code> 会查找最近的 <code>wrangler.toml</code>，并自动往 nitro 中注入正确的环境变量，非常方便。</p>
<h3 id="对于-nuxt"><a href="#对于-nuxt">对于 Nuxt</a></h3>
<p>只需要更新 <code>nuxt.config.ts</code>，加入如下代码即可：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#B392F0"> defineNuxtConfig</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">{</span></span>
<span class="line"><span style="color:#E1E4E8">  modules: </span><span style="color:#b392f0">[</span><span style="color:#9ECBFF">"nitro-cloudflare-dev"</span><span style="color:#b392f0">]</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#ffab70">}</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">;</span></span></code></pre>
<h3 id="对于-nitro"><a href="#对于-nitro">对于 Nitro</a></h3>
<p>对于 Nitro 更新 <code>nitro.config.ts</code>：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> nitroCloudflareBindings </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "nitro-cloudflare-dev"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#B392F0"> defineNitroConfig</span><span style="color:#79b8ff">(</span><span style="color:#ffab70">{</span></span>
<span class="line"><span style="color:#E1E4E8">  modules: </span><span style="color:#b392f0">[</span><span style="color:#E1E4E8">nitroCloudflareBindings</span><span style="color:#b392f0">]</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#ffab70">}</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">;</span></span></code></pre>
<h3 id="定义中间件使用-d1"><a href="#定义中间件使用-d1">定义中间件使用 D1</a></h3>
<p>中间件是大部分后端框架都有的功能，<a href="https://nitro.build/guide/routing#middleware">nitro 也不例外</a>。你使用的是 Nuxt，可以参考<a href="https://nuxt.com/docs/guide/directory-structure/server#server-middleware">官方文档</a> 来了解中间件。</p>
<p>本文基于 nitro 进行介绍，如果你使用的是 nuxt，那么唯一的区别就是中间件的路径不同，代码是一样的，如果你不了解中间件的话，无论如何都请先看一下官方教程！</p>
<p>首先我们创建一个 <code>server/middleware/d1.ts</code> 的文件，里面写入如下代码：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">{</span><span style="color:#E1E4E8"> drizzle, DrizzleD1Database </span><span style="color:#79b8ff">}</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'drizzle-orm/d1'</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#79B8FF"> *</span><span style="color:#F97583"> as</span><span style="color:#E1E4E8"> schema </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> '~/db/schema/user'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#F97583"> module</span><span style="color:#9ECBFF"> 'h3'</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">{</span></span>
<span class="line"><span style="color:#F97583">	interface</span><span style="color:#B392F0"> H3EventContext</span><span style="color:#E1E4E8"> </span><span style="color:#ffab70">{</span></span>
<span class="line"><span style="color:#FFAB70">		db</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DrizzleD1Database</span><span style="color:rgba(255, 18, 18, 0.8)">&#x3C;</span><span style="color:#F97583">typeof</span><span style="color:#E1E4E8"> schema</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">	</span><span style="color:#ffab70">}</span></span>
<span class="line"><span style="color:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> cloudflare</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#B392F0"> defineEventHandler</span><span style="color:#79b8ff">(</span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> </span><span style="color:#ffab70">(</span><span style="color:#b392f0">{</span><span style="color:#E1E4E8"> </span><span style="color:#FFAB70">context</span><span style="color:#E1E4E8"> </span><span style="color:#b392f0">}</span><span style="color:#ffab70">)</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=</span><span style="color:#F97583">></span><span style="color:#E1E4E8"> </span><span style="color:#ffab70">{</span></span>
<span class="line"><span style="color:#E1E4E8">	cloudflare </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> context.cloudflare </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> cloudflare</span></span>
<span class="line"><span style="color:#6A737D">	// 这里之所以是 DB 是因为我们在 `wrangler.toml` 里把 binding 设置为了 "DB"</span></span>
<span class="line"><span style="color:#F97583">	const</span><span style="color:#E1E4E8"> </span><span style="color:#b392f0">{</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">DB</span><span style="color:#E1E4E8"> </span><span style="color:#b392f0">}</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#b392f0">(</span><span style="color:#E1E4E8">context.cloudflare </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> cloudflare</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.env</span></span>
<span class="line"><span style="color:#E1E4E8">	context.db </span><span style="color:#F97583">=</span><span style="color:#B392F0"> drizzle</span><span style="color:#b392f0">(</span><span style="color:#79B8FF">DB</span><span style="color:#E1E4E8">, </span><span style="color:#79b8ff">{</span><span style="color:#E1E4E8"> schema: </span><span style="color:#ffab70">{</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">...</span><span style="color:#E1E4E8">schema </span><span style="color:#ffab70">}</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">}</span><span style="color:#b392f0">)</span></span>
<span class="line"><span style="color:#ffab70">}</span><span style="color:#79b8ff">)</span></span></code></pre>
<p>如图：</p>
<p><img alt="vscode: server/middleware/d1" loading="lazy" decoding="async" fetchpriority="auto" width="1534" height="892" src="/_astro/image-9.NWgbInkE_Z2regXI.webp" ></p>
<p>由于在经过任意一个路由的时候都会先经过中间件，所以每个路由的context里都会有一个名为db的属性，这便是我们的 DrizzleD1Database 对象。</p>
<p>例如，我们可以在 <code>server/routes/index.ts</code> 中写入如下代码：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">{</span><span style="color:#E1E4E8"> eq </span><span style="color:#79b8ff">}</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "drizzle-orm"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> </span><span style="color:#79b8ff">{</span><span style="color:#E1E4E8"> usersTable </span><span style="color:#79b8ff">}</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "~/db/schema/user"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#B392F0"> eventHandler</span><span style="color:#79b8ff">(</span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> </span><span style="color:#ffab70">(</span><span style="color:#FFAB70">event</span><span style="color:#ffab70">)</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=</span><span style="color:#F97583">></span><span style="color:#E1E4E8"> </span><span style="color:#ffab70">{</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> zhangsan</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> </span><span style="color:#b392f0">(</span><span style="color:#F97583">await</span><span style="color:#E1E4E8"> event.context.db.</span><span style="color:#B392F0">select</span><span style="color:#79b8ff">(</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">from</span><span style="color:#79b8ff">(</span><span style="color:#E1E4E8">usersTable</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">where</span><span style="color:#79b8ff">(</span><span style="color:#B392F0">eq</span><span style="color:#ffab70">(</span><span style="color:#E1E4E8">usersTable.name, </span><span style="color:#9ECBFF">"zhangsan"</span><span style="color:#ffab70">)</span><span style="color:#79b8ff">)</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">at</span><span style="color:#b392f0">(</span><span style="color:#79B8FF">0</span><span style="color:#b392f0">)</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#b392f0">(</span><span style="color:#E1E4E8">zhangsan</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8"> </span><span style="color:#b392f0">{</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> zhangsan</span></span>
<span class="line"><span style="color:#E1E4E8">  </span><span style="color:#b392f0">}</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> res</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> event.context.db.</span><span style="color:#B392F0">insert</span><span style="color:#b392f0">(</span><span style="color:#E1E4E8">usersTable</span><span style="color:#b392f0">)</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">values</span><span style="color:#b392f0">(</span><span style="color:#79b8ff">{</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">"zhangsan"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    age: </span><span style="color:#79B8FF">18</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    email: </span><span style="color:#9ECBFF">"zhangsan@outlook.com"</span></span>
<span class="line"><span style="color:#E1E4E8">  </span><span style="color:#79b8ff">}</span><span style="color:#b392f0">)</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> </span><span style="color:#b392f0">{</span></span>
<span class="line"><span style="color:#E1E4E8">    ok: </span><span style="color:#79B8FF">true</span></span>
<span class="line"><span style="color:#E1E4E8">  </span><span style="color:#b392f0">}</span></span>
<span class="line"><span style="color:#ffab70">}</span><span style="color:#79b8ff">)</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>如图：</p>
<p><img alt="vscode: server/routes/index" loading="lazy" decoding="async" fetchpriority="auto" width="2280" height="1020" src="/_astro/image-10.CEOJH5E8_23Ie1k.webp" ></p>
<p>然后启动我们的项目：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpm</span><span style="color:#9ECBFF"> dev</span></span></code></pre>
<p>第一次打开的时候会往数据库里写入数据, 第二次打开的时候就会从数据库里取出数据并返回。</p>
<h2 id="部署"><a href="#部署">部署</a></h2>
<h3 id="迁移到分布式数据库"><a href="#迁移到分布式数据库">迁移到分布式数据库</a></h3>
<p>刚才我们仅仅把 SQL 应用到了本地环境里，那么现在我们要把 SQL 迁移到正经的线上环境里，可以使用这条指令:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">pnpx</span><span style="color:#9ECBFF"> wrangler</span><span style="color:#9ECBFF"> d1</span><span style="color:#9ECBFF"> migrations</span><span style="color:#9ECBFF"> apply</span><span style="color:#9ECBFF"> Test</span><span style="color:#79B8FF"> --remote</span></span></code></pre>
<h3 id="部署-1"><a href="#部署-1">部署</a></h3>
<p>以上便是使用 Cloudflare Worker + D1 Database 开发的全部流程，如果你一切就绪，就差部署到 Cloudflare，那么只要把这个项目上传到 GitHub，然后进入 Cloudflare 的 Dashboard，点击创建 Worker，再点击连接到 git，最后选择你的项目所在的仓库即可：</p>
<p><img alt="cloudflare dashboard: connect git" loading="lazy" decoding="async" fetchpriority="auto" width="2311" height="777" src="/_astro/image-11.9dy9Qr3o_1HMT5G.webp" ></p>
<p>如果你把 <code>wrangler.toml</code> 放在你的项目根目录下，那么 Cloudflare 是会自动把数据库注入到你的项目里，如果你想手动注入的话，可以在 <code>Workers &#x26; Pages</code> -> 选择一个项目 -> <code>设置</code> -> <code>绑定</code>，然后选择 <code>D1 Database</code>，输入<strong>绑定名称</strong>，并且选择你的数据库即可：</p>
<p><img alt="cloudflare dashboard: bind d1" loading="lazy" decoding="async" fetchpriority="auto" width="1078" height="579" src="/_astro/image-12.CtWgsBHN_ZrJrAo.webp" ></p>
<p>如果你的绑定名称输入的不是 <code>DB</code> 的话，还需要修改一下你的中间件，可以参考我在上文的 <code>d1.ts</code> 中写的注释。</p>
<section data-footnotes="" class="footnotes"><h2 class="sr-only" id="footnote-label"><a href="#footnote-label">Footnotes</a></h2>
<ol>
<li id="user-content-fn-https://developers.cloudflare.com/workers/platform/limits/#worker-size">
<p><a href="https://developers.cloudflare.com/workers/platform/limits/#worker-size">https://developers.cloudflare.com/workers/platform/limits/#worker-size</a> <a href="#user-content-fnref-https://developers.cloudflare.com/workers/platform/limits/#worker-size" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section>  </article> </div> <div class="max-sm:glassmorphism rounded-lg mt-2 sm:mt-6 p-2 pt-6"> <script type="module" src="/_astro/Giscus.astro_astro_type_script_index_0_lang.C2pfN53L.js"></script> <giscus-widget repo="miaobuao/miaobuao.github.io" repoId="R_kgDOJONNeg" categoryId="DIC_kwDOJONNes4CVJhu" mapping="og:title" strict="0" reactionsEnabled="1" emitMetadata="0" inputPosition="top" theme="preferred_color_scheme" lang="zh-CN" loading="lazy"></giscus-widget> </div> <div class="h-16 sm:h-0"></div>  </div> </main> </div> </div></div> </div><astro-island uid="gD63X" component-url="/_astro/WindowManager.DgB5G-u_.js" component-export="WindowManager" renderer-url="/_astro/client.DkS6DsO7.js" props="{&quot;class&quot;:[0,&quot;invisible md:visible not-md:pointer-events-none&quot;],&quot;data-astro-transition-persist&quot;:[0,&quot;wm&quot;]}" ssr client="only" opts="{&quot;name&quot;:&quot;WindowManager&quot;,&quot;value&quot;:&quot;solid-js&quot;}" data-astro-transition-persist="wm"></astro-island>  </body></html> <script defer>
	window.addEventListener(
		'wheel',
		(e) => {
			const scrollContainer = document.getElementById('main-scroll-container')
			if (e.target !== document.body) {
				return
			}
			e.preventDefault()
			scrollContainer.scrollTop += e.deltaY
		},
		{ passive: false },
	)
</script>